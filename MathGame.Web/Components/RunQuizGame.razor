@using MathGame.Web.Models.Quiz
@using Microsoft.JSInterop
@using Microsoft.Extensions.Configuration
@typeparam T where T : IComparable<T>
@inject ISnackbar SnackBar
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@implements IAsyncDisposable


<MudPaper Elevation="4" Class="p-4 mb-4">
    <MudGrid>
        @* Column 1: Quiz Title and Description *@
        <MudItem xs="12" md="4">
            <MudText Typo="Typo.h2">@Game.QuizTitle</MudText>
            <MudText Typo="Typo.subtitle1">@Game.QuizDescription</MudText>
            <MudText>Kortteja jäljellä: @Game.TotalQuestionsLeft / @Game.TotalQuestions</MudText>
            <MudText Typo="Typo.caption" Color="Color.Info" Class="mt-2">
                ⌨️ Nuolet: Valitse | Space/Enter: Vahvista/Jatka | W: Web | D: Desktop
            </MudText>
            <MudSwitch @bind-Value="_hideCardNames" Color="Color.Info" Class="mt-3">
                Piilota kappaleiden nimet muilta pelaajilta
            </MudSwitch>
        </MudItem>

        @* Column 2: Current Song and Buttons *@
        <MudItem xs="12" md="4">
            @if (CurrentItem is not null && !string.IsNullOrEmpty(CurrentItem.Uri))
            {
                var trackId = CurrentItem.Uri.Split(':').Last();
                var spotifyWebUrl = $"https://open.spotify.com/track/{trackId}";
                var spotifyDesktopUrl = CurrentItem.Uri;

                <MudText Typo="Typo.h5" Class="mb-3">🎵 Nykyinen kappale</MudText>
                <MudText Typo="Typo.body2" Class="mb-2">Avaa Spotify kuunnellaksesi kappaletta:</MudText>

                <MudStack Spacing="2">
                    <MudButton
                        Href="@spotifyWebUrl"
                        Target="_blank"
                        Variant="Variant.Filled"
                        Color="Color.Success"
                        StartIcon="@Icons.Material.Filled.Language"
                        FullWidth="true">
                        Spotify Web <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Style="color: white;">W</MudChip>
                    </MudButton>

                    <MudButton
                        Href="@spotifyDesktopUrl"
                        Target="_blank"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.DesktopWindows"
                        FullWidth="true">
                        Spotify Desktop <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Style="color: white;">D</MudChip>
                    </MudButton>
                </MudStack>

                <MudText Typo="Typo.caption" Class="mt-3" Color="Color.Info">
                    💡 Vinkki: Käytä Spotify Web -linkkiä mobiililaitteilla tai Spotify Desktop -linkkiä tietokoneella.
                </MudText>
            }
            @if (CurrentItem is null && _answerGiven)
            {
                <MudText Typo="Typo.h5" Color="Color.Tertiary">Odotetaan seuraavaa kierrosta...</MudText>
            }
        </MudItem>

        @* Column 3: QR Code *@
        <MudItem xs="12" md="4" Class="d-flex flex-column align-center justify-center">
            @if (CurrentItem is not null && !string.IsNullOrEmpty(CurrentItem.Uri))
            {
                var trackId = CurrentItem.Uri.Split(':').Last();
                var spotifyWebUrl = $"https://open.spotify.com/track/{trackId}";
                // Primary color (Christmas Red) with black/white background based on mode
                var qrColor = "c41e3a"; // Christmas Red (Primary)
                var qrBgColor = IsDarkMode ? "000000" : "ffffff"; // Black in dark mode, white in light
                var qrCodeUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=200x200&color={qrColor}&bgcolor={qrBgColor}&data={Uri.EscapeDataString(spotifyWebUrl)}";

                <MudText Typo="Typo.body2" Class="mb-2">Tai skannaa QR-koodi:</MudText>
                <MudPaper Elevation="3" Class="pa-2" Style="@($"background-color: {(IsDarkMode ? "#000000" : "white")};")">
                    <MudImage Src="@qrCodeUrl" Alt="QR Code for Spotify" Width="200" Height="200" />
                </MudPaper>
            }
        </MudItem>
    </MudGrid>
</MudPaper>

@* Pelaajat riveittäin - scrollaava *@
<div style="max-height: 60vh; overflow-y: auto; margin-bottom: 1rem;">
@foreach (var player in Game.Players)
{
    var isActivePlayer = Game.CurrentPlayer == player;
    var elevation = isActivePlayer ? 8 : 2;
    var borderColor = isActivePlayer ? "border-left: 4px solid var(--mud-palette-primary);" : "";

    <MudPaper Elevation="@elevation" Class="p-4 mb-3" Style="@borderColor">
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6">
                    @player.Name
                    @if (isActivePlayer)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Vuorossa</MudChip>
                    }
                    @if (_challengeMode && player == _challengedPlayer)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Haastettu!</MudChip>
                    }
                    @if (_challengeMode && player == _challengingPlayer)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Haastaa</MudChip>
                    }
                </MudText>
                <MudText Color="Color.Success">Pisteet: @player.Cards.Count</MudText>
                @if (Game.UseRyostoCards)
                {
                    <MudText Color="Color.Warning">🎴 Ryöstökortit: @player.RyostoCards</MudText>
                }
                @if (player.FailedCards.Count > 0)
                {
                    <MudButton OnClick="() => ShowFailedCardsHistory(player)" 
                               Variant="Variant.Text" 
                               Color="Color.Error" 
                               Size="Size.Small">
                        Väärät: @player.FailedCards.Count
                    </MudButton>
                }
                @if (Game.UseRyostoCards && isActivePlayer && CurrentItem != null && !_challengeMode)
                {
                    <MudButton OnClick="UseRyostoSkipSong"
                               Variant="Variant.Outlined"
                               Color="Color.Warning"
                               Size="Size.Small"
                               Disabled="@(player.RyostoCards < 1)"
                               Style="margin-left: 8px;">
                        🎴 Ohita kappale (1)
                    </MudButton>
                    <MudButton OnClick="UseRyostoTradeForCard"
                               Variant="Variant.Outlined"
                               Color="Color.Warning"
                               Size="Size.Small"
                               Disabled="@(player.RyostoCards < 3)"
                               Style="margin-left: 8px;">
                        🎴 Vaihda korttiin (3)
                    </MudButton>
                }
                @if (Game.UseRyostoCards && !isActivePlayer && CurrentItem != null && !_challengeMode && _activePlacementKey != null && Game.CurrentPlayer != null && (Game.CurrentPlayer.Cards.Count > 0 || !Game.UseDecadeGuessing))
                {
                    <MudButton OnClick="() => StartChallenge(player)"
                               Variant="Variant.Outlined"
                               Color="Color.Error"
                               Size="Size.Small"
                               Disabled="@(player.RyostoCards < 1)"
                               Style="margin-left: 8px;">
                        🎴 Haasta! (1)
                    </MudButton>
                }
                @if (_challengeMode && player == _challengingPlayer)
                {
                    <MudButton OnClick="CancelChallenge"
                               Variant="Variant.Text"
                               Color="Color.Default"
                               Size="Size.Small"
                               Style="margin-left: 8px;">
                        Peruuta haaste
                    </MudButton>
                }
            </MudStack>
            <MudStack Row>
                <MudButton OnClick="ShowWinnerCelebration" 
                           Variant="Variant.Filled" 
                           Color="Color.Success" 
                           StartIcon="@Icons.Material.Filled.EmojiEvents"
                           Size="Size.Small">
                    Juhli voittajaa!
                </MudButton>
                <MudMenu Icon="@Icons.Material.Filled.AdminPanelSettings" 
                         Color="Color.Secondary" 
                         Variant="Variant.Outlined"
                         Size="Size.Small"
                         Label="Pelinjohtaja"
                         Dense="false"
                         FullWidth="false">
                    @if (Game.UseRyostoCards)
                    {
                        <MudMenuItem OnClick="() => AdjustRyostoCards(player, 1)">
                            ➕ Lisää ryöstokortti
                        </MudMenuItem>
                        <MudMenuItem OnClick="() => AdjustRyostoCards(player, -1)" Disabled="@(player.RyostoCards <= 0)">
                            ➖ Poista ryöstokortti
                        </MudMenuItem>
                        <MudDivider />
                    }
                    <MudMenuItem OnClick="() => ShowAddManualCard(player)">
                        ➕ Lisää kortti manuaalisesti
                    </MudMenuItem>
                </MudMenu>
            </MudStack>
        </MudStack>

        @* Pelaajan kortit horisontaalisesti *@
        <MudStack Row Class="mt-3" Style="overflow-x: auto; flex-wrap: nowrap; position: relative; padding-left: 20px;">
            @{
                var hasNoCards = player.Cards.Count == 0;
                var shouldHidePlacementForNoCards = hasNoCards && Game.UseDecadeGuessing;
                var showPlacementButtons = (isActivePlayer && CurrentItem is not null && !_challengeMode && !shouldHidePlacementForNoCards) || 
                                          (_challengeMode && player == _challengedPlayer);
            }
            
            @* Aseta tähän -painike ennen ensimmäistä korttia *@
            @if (showPlacementButtons)
            {
                var placementKey = $"{player.Name}_null";
                var isActivePlacement = _challengeMode ? _selectedChallengePositionKey == placementKey : _activePlacementKey == placementKey;
                var placementIndex = _availablePlacements.FindIndex(p => p.key == placementKey);
                <div style="position: relative; width: 0; display: flex; flex-direction: column; align-items: center; z-index: 10;">
                    <MudIconButton
                        OnClick="@(() => { if (_challengeMode) SelectChallengePosition(placementKey); else TogglePlacement(player, placementKey, null, player.Cards.FirstOrDefault()); })"
                        Icon="@(isActivePlacement ? Icons.Material.Filled.AddCircle : Icons.Material.Outlined.AddCircleOutline)"
                        Color="@(isActivePlacement ? Color.Default : (_challengeMode ? Color.Error : Color.Secondary))"
                        Size="Size.Large"
                        Style="@(isActivePlacement ? "margin-left: -20px; color: white;" : "margin-left: -20px;")" />
                    @if (placementIndex >= 0 && placementIndex <= 9 && !_challengeMode)
                    {
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Style="color: white; font-weight: bold;">@placementIndex</MudChip>
                    }
                </div>
            }

            @if (player.Cards.Count == 0)
            {
                <MudText Color="Color.Tertiary" Class="align-self-center">Ei vielä kortteja</MudText>
            }
            else
            {
                for (int i = 0; i < player.Cards.Count; i++)
                {
                    var item = player.Cards[i];
                    var cardIndex = i;

                    <MudCard Style="min-width: 150px; max-width: 150px;">
                        <MudCardContent>
                            <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Primary">@item.value</MudText>
                            @if (isActivePlayer || !_hideCardNames)
                            {
                                <MudText Typo="Typo.body2" Align="Align.Center" Style="font-size: 0.75rem;">@item.text</MudText>
                            }
                        </MudCardContent>
                    </MudCard>

                    @* Aseta tähän -painike korttien välissä *@
                    @if (showPlacementButtons)
                    {
                        var prev = player.Cards[cardIndex];
                        var next = cardIndex + 1 < player.Cards.Count ? player.Cards[cardIndex + 1] : null;
                        
                        @* Piilota painike jos molemmat puolet ovat samaa arvoa *@
                        var shouldShowButton = next == null || !Equals(prev.value, next.value);
                        
                        if (shouldShowButton)
                        {
                            var placementKey = $"{player.Name}_{prev.id}";
                            var isActivePlacement = _challengeMode ? _selectedChallengePositionKey == placementKey : _activePlacementKey == placementKey;
                            var placementIndex = _availablePlacements.FindIndex(p => p.key == placementKey);

                            <div style="position: relative; width: 0; display: flex; flex-direction: column; align-items: center; z-index: 10;">
                                <MudIconButton
                                    OnClick="@(() => { if (_challengeMode) SelectChallengePosition(placementKey); else TogglePlacement(player, placementKey, prev, next); })"
                                    Icon="@(isActivePlacement ? Icons.Material.Filled.AddCircle : Icons.Material.Outlined.AddCircleOutline)"
                                    Color="@(isActivePlacement ? Color.Default : (_challengeMode ? Color.Error : Color.Secondary))"
                                    Size="Size.Large"
                                    Style="@(isActivePlacement ? "margin-left: -20px; color: white;" : "margin-left: -20px;")" />
                                @if (placementIndex >= 0 && placementIndex <= 9 && !_challengeMode)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Style="color: white; font-weight: bold;">@placementIndex</MudChip>
                                }
                            </div>
                        }
                    }
                }
            }
        </MudStack>

        @* Vuosikymmenvalinta kun ei kortteja *@
        @if (Game.UseDecadeGuessing && isActivePlayer && CurrentItem is not null && !_challengeMode && player.Cards.Count == 0)
        {
            var decades = Game.GetAvailableDecades();
            <MudPaper Class="mt-4 pa-4" Elevation="8" Style="background: linear-gradient(135deg, rgba(196, 30, 58, 0.1) 0%, rgba(22, 91, 51, 0.1) 100%); border: 2px solid var(--mud-palette-warning);">
                <MudText Typo="Typo.h5" Color="Color.Warning" Class="mb-3" Align="Align.Center" Style="font-weight: bold;">
                    ⚠️ ERIKOISSÄÄNTÖ: Arvaa kappaleen vuosikymmen!
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Default" Class="mb-4" Align="Align.Center">
                    Kun sinulla ei ole kortteja, sinun täytyy arvata oikea vuosikymmen
                </MudText>
                <MudStack Row Spacing="3" Style="flex-wrap: wrap; justify-content: center;">
                    @foreach (var decade in decades)
                    {
                        var isSelected = _selectedDecade == decade;
                        <MudButton 
                            OnClick="() => SelectDecade(decade)"
                            Variant="Variant.Filled"
                            Color="@(isSelected ? Color.Primary : Color.Default)"
                            Size="Size.Large"
                            Style="@(isSelected ? "min-width: 140px; height: 80px; font-size: 1.5rem; font-weight: bold;" : "min-width: 140px; height: 80px; font-size: 1.3rem; background-color: white; color: black; border: 2px solid #ddd;")">
                            @decade-luku
                        </MudButton>
                    }
                </MudStack>
                @if (_selectedDecade.HasValue)
                {
                    <MudButton 
                        OnClick="ConfirmDecadeGuess"
                        Variant="Variant.Filled"
                        Color="Color.Success"
                        FullWidth="true"
                        Class="mt-4"
                        Size="Size.Large"
                        Style="height: 70px; font-size: 1.4rem; font-weight: bold;">
                        ✅ Vahvista arvaus: @_selectedDecade-luku
                    </MudButton>
                }
            </MudPaper>
        }
    </MudPaper>
}
</div>

@* Vahvista haaste -painike *@
@if (_challengeMode && _selectedChallengePositionKey != null)
{
    var selectedPlacement = _availablePlacements.FirstOrDefault(p => p.key == _selectedChallengePositionKey);
    <MudButton Variant="Variant.Filled" 
               Color="Color.Error" 
               OnClick="() => ConfirmChallenge(selectedPlacement.prev, selectedPlacement.next)" 
               FullWidth="true" 
               Size="Size.Large"
               Class="mb-3">
        Vahvista haaste!
    </MudButton>
}

@* Seuraava pelaaja -painike *@
@if (CurrentItem is null && _answerGiven)
{
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NextPlayerTurn" FullWidth="true" Size="Size.Large">
        Seuraava pelaaja <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Style="color: white;">Space</MudChip>
    </MudButton>
}

@* Dialogi vastauksen tulokselle *@
<MudDialog @bind-Visible="_showResultDialog" Options="_dialogOptions">
    <TitleContent>
        <MudPaper Class="pa-4" Style="@(_lastAnswerCorrect ? "background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);" : "background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);")">
            <MudText Typo="Typo.h3" Align="Align.Center" Style="color: white; font-weight: bold;">
                @if (_lastAnswerCorrect)
                {
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Style="color: white;" />
                    <text> OIKEIN!</text>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Large" Style="color: white;" />
                    <text> VÄÄRIN!</text>
                }
            </MudText>
        </MudPaper>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3" AlignItems="AlignItems.Center" Class="pt-4">
            <MudText Typo="Typo.h3" Align="Align.Center" Style="font-weight: bold;">@_lastAnswerText</MudText>
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Primary" Style="font-weight: bold;">
                    Arvo:
                </MudText>
                @if (_isEditingValue)
                {
                    <MudTextField @bind-Value="_editedValue" 
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense"
                                  Style="width: 100px;" />
                    <MudIconButton Icon="@Icons.Material.Filled.Check" 
                                   Color="Color.Success" 
                                   OnClick="SaveEditedValue"
                                   Size="Size.Small" />
                    <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                   Color="Color.Error" 
                                   OnClick="CancelEditValue"
                                   Size="Size.Small" />
                }
                else
                {
                    <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Primary" Style="font-weight: bold;">
                        @_lastAnswerValue
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Color="Color.Primary" 
                                   OnClick="StartEditValue"
                                   Size="Size.Small" />
                }
            </MudStack>
            
            @if (!string.IsNullOrEmpty(_lastAnswerText))
            {
                var searchQuery = $"release date {_lastAnswerText}";
                var searchUrl = $"https://www.google.com/search?q={Uri.EscapeDataString(searchQuery)}";
                
                <MudButton
                    Href="@searchUrl"
                    Target="_blank"
                    Variant="Variant.Outlined"
                    Color="Color.Info"
                    StartIcon="@Icons.Material.Filled.Search"
                    Size="Size.Small">
                    Tarkista julkaisuvuosi
                </MudButton>
            }
            
            @if (Game.UseRyostoCards && _lastAnswerPlayer != null)
            {
                <MudDivider Class="my-3" />
                <MudCheckBox @bind-Value="_guessedArtistAndSong" 
                             Color="Color.Warning"
                             Label="🎤 Pelaaja arvasi myös artisti & kappaleen oikein (+1 🎴)" />
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseResultDialog" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large">
            Jatka <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Style="color: white;">Space</MudChip>
        </MudButton>
    </DialogActions>
</MudDialog>

@* Dialogi väärien vastausten historialle *@
<MudDialog @bind-Visible="_showFailedHistoryDialog" Options="_historyDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h5">
            @_selectedPlayer?.Name - Väärät vastaukset
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedPlayer?.FailedCards.Count > 0)
        {
            <MudList T="string">
                @foreach (var card in _selectedPlayer.FailedCards)
                {
                    <MudListItem T="string">
                        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body1"><strong>@card.text</strong></MudText>
                                <MudText Typo="Typo.body2" Color="Color.Primary">Arvo: @card.value</MudText>
                            </MudStack>
                            @if (!string.IsNullOrEmpty(card.Uri))
                            {
                                var trackId = card.Uri.Split(':').Last();
                                var spotifyWebUrl = $"https://open.spotify.com/track/{trackId}";
                                <MudIconButton Href="@spotifyWebUrl" 
                                             Target="_blank" 
                                             Icon="@Icons.Material.Filled.MusicNote" 
                                             Color="Color.Success" 
                                             Size="Size.Small" />
                            }
                        </MudStack>
                    </MudListItem>
                    <MudDivider />
                }
            </MudList>
        }
        else
        {
            <MudText>Ei vääriä vastauksia</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseFailedHistoryDialog" Variant="Variant.Filled" Color="Color.Primary">
            Sulje
        </MudButton>
    </DialogActions>
</MudDialog>

@* Dialogi haasteen tulokselle *@
<MudDialog @bind-Visible="_showChallengeResultDialog" Options="_challengeResultDialogOptions">
    <TitleContent>
        <MudPaper Class="pa-4" Style="background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);">
            <MudText Typo="Typo.h3" Align="Align.Center" Style="color: white; font-weight: bold;">
                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Large" Style="color: white;" />
                HAASTE!
            </MudText>
        </MudPaper>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3" Class="pt-4">
            @* Song info *@
            <MudText Typo="Typo.h4" Align="Align.Center" Style="font-weight: bold;">@_lastAnswerText</MudText>
            
            @* Correct value display with edit capability *@
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Justify="Justify.Center">
                <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Primary" Style="font-weight: bold;">
                    Arvo:
                </MudText>
                @if (_isEditingValue)
                {
                    <MudTextField @bind-Value="_editedValue" 
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense"
                                  Style="width: 100px;" />
                    <MudIconButton Icon="@Icons.Material.Filled.Check" 
                                   Color="Color.Success" 
                                   OnClick="SaveEditedChallengeValue"
                                   Size="Size.Small" />
                    <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                   Color="Color.Error" 
                                   OnClick="CancelEditValue"
                                   Size="Size.Small" />
                }
                else
                {
                    <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Primary" Style="font-weight: bold;">
                        @_lastAnswerValue
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Color="Color.Primary" 
                                   OnClick="StartEditValue"
                                   Size="Size.Small" />
                }
            </MudStack>
            
            @* Challenged player's answer (ORIGINAL PLAYER) *@
            <MudPaper Elevation="4" Class="pa-3" Style="@(_challengedWasCorrect ? "background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);" : "background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);")">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6" Style="color: white; font-weight: bold;">
                        @if (_challengedWasCorrect)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Medium" Style="color: white;" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Medium" Style="color: white;" />
                        }
                        Alkuperäinen vastaus: @_lastChallengedPlayer?.Name
                    </MudText>
                    <MudText Typo="Typo.h6" Style="color: white; font-weight: bold;">
                        Väli: @FormatPlacementRange(_lastChallengedPrev, _lastChallengedNext)
                    </MudText>
                </MudStack>
            </MudPaper>
            
            @* Challenger's answer *@
            <MudPaper Elevation="4" Class="pa-3" Style="@(_challengerWasCorrect ? "background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);" : "background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);")">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6" Style="color: white; font-weight: bold;">
                        @if (_challengerWasCorrect)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Medium" Style="color: white;" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Medium" Style="color: white;" />
                        }
                        Haastajan vastaus: @_lastChallengerPlayer?.Name
                    </MudText>
                    <MudText Typo="Typo.h6" Style="color: white; font-weight: bold;">
                        Väli: @FormatPlacementRange(_lastChallengerPrev, _lastChallengerNext)
                    </MudText>
                </MudStack>
            </MudPaper>
            
            @* Winner announcement *@
            <MudPaper Elevation="2" Class="pa-3" Style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);">
                <MudText Typo="Typo.h5" Align="Align.Center" Style="color: #333; font-weight: bold;">
                    @if (_lastAnswerCorrect && _lastAnswerPlayer == _lastChallengedPlayer)
                    {
                        <text>🏆 Alkuperäinen vastaus oli oikein - @_lastChallengedPlayer?.Name saa kortin!</text>
                    }
                    else if (_lastAnswerCorrect && _lastAnswerPlayer == _lastChallengerPlayer)
                    {
                        <text>🏆 Haastaja voitti - @_lastChallengerPlayer?.Name saa kortin!</text>
                    }
                    else
                    {
                        <text>❌ Molemmat väärin - ei pistettä!</text>
                    }
                </MudText>
            </MudPaper>
            
            @if (!string.IsNullOrEmpty(_lastAnswerText))
            {
                var searchQuery = $"release date {_lastAnswerText}";
                var searchUrl = $"https://www.google.com/search?q={Uri.EscapeDataString(searchQuery)}";
                
                <MudButton
                    Href="@searchUrl"
                    Target="_blank"
                    Variant="Variant.Outlined"
                    Color="Color.Info"
                    StartIcon="@Icons.Material.Filled.Search"
                    Size="Size.Small"
                    FullWidth="true">
                    Tarkista julkaisuvuosi
                </MudButton>
            }
            
            @if (Game.UseRyostoCards && _lastChallengedPlayer != null)
            {
                <MudDivider Class="my-3" />
                <MudCheckBox @bind-Value="_guessedArtistAndSong" 
                             Color="Color.Warning"
                             Label="🎤 Alkuperäinen pelaaja arvasi myös artisti & kappaleen oikein (+1 🎴)" />
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseChallengeResultDialog" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large">
            Jatka <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Style="color: white;">Space</MudChip>
        </MudButton>
    </DialogActions>
</MudDialog>

@* Dialogi voittajan juhlalle *@
<MudDialog @bind-Visible="_showWinnerDialog" Options="_winnerDialogOptions">
    <TitleContent>
        <MudPaper Class="pa-4" Style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);">
            <MudText Typo="Typo.h3" Align="Align.Center" Style="color: #333; font-weight: bold;">
                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Large" Style="color: #333;" />
                VOITTAJA!
            </MudText>
        </MudPaper>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3" AlignItems="AlignItems.Center" Class="pt-4">
            @foreach (var player in Game.Players.OrderByDescending(p => p.Cards.Count))
            {
                var isWinner = player == Game.Players.OrderByDescending(p => p.Cards.Count).First();
                <MudPaper Elevation="@(isWinner ? 8 : 2)" Class="pa-3" Style="@(isWinner ? "background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); width: 100%;" : "width: 100%;")">
                    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                            @if (isWinner)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Large" />
                            }
                            <MudText Typo="@(isWinner ? Typo.h5 : Typo.h6)" Style="@(isWinner ? "font-weight: bold; color: #333;" : "")">
                                @player.Name
                            </MudText>
                        </MudStack>
                        <MudText Typo="@(isWinner ? Typo.h5 : Typo.h6)" Color="@(isWinner ? Color.Dark : Color.Success)" Style="@(isWinner ? "font-weight: bold;" : "")">
                            @player.Cards.Count pistettä
                        </MudText>
                    </MudStack>
                </MudPaper>
            }
            
            @if (!string.IsNullOrEmpty(_celebrationTrackId))
            {
                var spotifyWebUrl = $"https://open.spotify.com/track/{_celebrationTrackId}";
                var spotifyDesktopUrl = $"spotify:track:{_celebrationTrackId}";
                
                <MudDivider Class="my-3" />
                
                <MudText Typo="Typo.h6" Class="mb-2">🎉 Juhlakappale:</MudText>
                
                <MudStack Row Spacing="2">
                    <MudButton
                        Href="@spotifyWebUrl"
                        Target="_blank"
                        Variant="Variant.Filled"
                        Color="Color.Success"
                        StartIcon="@Icons.Material.Filled.Language">
                        Spotify Web
                    </MudButton>
                    
                    <MudButton
                        Href="@spotifyDesktopUrl"
                        Target="_blank"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.DesktopWindows">
                        Spotify Desktop
                    </MudButton>
                </MudStack>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseWinnerDialog" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true">
            Sulje
        </MudButton>
    </DialogActions>
</MudDialog>

@* Dialogi manuaaliselle kortin lisäykselle *@
<MudDialog @bind-Visible="_showAddManualCardDialog" Options="_manualCardDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Lisää kortti pelaajalle: @_manualCardPlayer?.Name</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_manualCardValue"
                      Label="Vuosiluku"
                      Variant="Variant.Outlined"
                      HelperText="Syötä kortin vuosiluku (esim. 1985)"
                      Immediate="true" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelAddManualCard" Variant="Variant.Text">Peruuta</MudButton>
        <MudButton OnClick="ConfirmAddManualCard" Variant="Variant.Filled" Color="Color.Primary">Lisää</MudButton>
    </DialogActions>
</MudDialog>


@code {
    [Parameter] public required QuizGame<T> Game { get; set; }
    [CascadingParameter(Name = "IsDarkMode")] public bool IsDarkMode { get; set; }

    private QuizItem<T>? CurrentItem;
    private bool _answerGiven = false;
    
    // Tulosdialogi
    private bool _showResultDialog = false;
    private bool _lastAnswerCorrect = false;
    private string _lastAnswerText = "";
    private string _lastAnswerValue = "";
    private string _lastAnswerUri = "";
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };
    
    // Historian dialogi
    private bool _showFailedHistoryDialog = false;
    private Player<T>? _selectedPlayer;
    private DialogOptions _historyDialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };
    
    // Voittajan dialogi
    private bool _showWinnerDialog = false;
    private DialogOptions _winnerDialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };
    private string? _celebrationTrackId;
    
    // Manuaalisen kortin lisäys
    private bool _showAddManualCardDialog = false;
    private Player<T>? _manualCardPlayer = null;
    private string _manualCardValue = "";
    private DialogOptions _manualCardDialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };
    
    // Esitystila
    private bool _hideCardNames = false;
    
    // Arvon muokkaus
    private bool _isEditingValue = false;
    private string _editedValue = "";
    private QuizItem<T>? _lastAnswerItem;
    private Player<T>? _lastAnswerPlayer;
    private QuizItem<T>? _lastAnswerPrev;
    private QuizItem<T>? _lastAnswerNext;
    
    // Asettamisen tila
    private string? _activePlacementKey = null;
    private QuizItem<T>? _activePlacementPrev = null;  // Tallenna aktiivisen valinnan prev
    private QuizItem<T>? _activePlacementNext = null;  // Tallenna aktiivisen valinnan next
    
    // Näppäimistötila
    private int _currentPlacementIndex = 0;
    private List<(string key, Player<T> player, QuizItem<T>? prev, QuizItem<T>? next)> _availablePlacements = new();
    private DotNetObjectReference<RunQuizGame<T>>? _dotNetRef;
    
    // Haastetila
    private bool _challengeMode = false;
    private Player<T>? _challengingPlayer = null;
    private Player<T>? _challengedPlayer = null;
    private string? _selectedChallengePositionKey = null;
    private QuizItem<T>? _originalPlacementPrev = null;
    private QuizItem<T>? _originalPlacementNext = null;
    
    // Challenge result dialog
    private bool _showChallengeResultDialog = false;
    private bool _challengerWasCorrect = false;
    private bool _challengedWasCorrect = false;
    private Player<T>? _lastChallengerPlayer = null;
    private Player<T>? _lastChallengedPlayer = null;
    private string _lastChallengerValue = "";
    private string _lastChallengedValue = "";
    private QuizItem<T>? _lastChallengerPrev = null;
    private QuizItem<T>? _lastChallengerNext = null;
    private QuizItem<T>? _lastChallengedPrev = null;
    private QuizItem<T>? _lastChallengedNext = null;
    private DialogOptions _challengeResultDialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };
    
    // Vuosikymmenvalinta (kun vain 1 kortti)
    private int? _selectedDecade = null;
    
    // Artisti & kappale -arvaus (checkbox vastausdialgissa)
    private bool _guessedArtistAndSong = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            if (Game is null)
            {
                throw new ArgumentNullException(nameof(Game), "Game parameter must be set.");
            }

            if (Game.Players.Count == 0)
            {
                throw new InvalidOperationException("At least one player must be added to the game before starting.");
            }

            foreach (var gamePlayer in Game.Players)
            {
                // Draw initial cards for each player
                for (int i = 0; i < Game.InitialCardsPerPlayer; i++)
                {
                    var item = Game.GetRandomQuestion();
                    if (item is not null)
                    {
                        gamePlayer.AddCard(item);
                    }
                }
                gamePlayer.SortCards();
            }

            // Nosta ensimmäinen kortti ensimmäiselle pelaajalle
            await DrawNext();
            
            // Setup keyboard listener
            _dotNetRef = DotNetObjectReference.Create(this);
            await SetupKeyboardListener();
            
            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }
    
    private async Task SetupKeyboardListener()
    {
        // Try to setup keyboard listener with retries
        for (int i = 0; i < 5; i++)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("setupKeyboardListener", _dotNetRef);
                return; // Success!
            }
            catch (JSException)
            {
                if (i < 4) // Don't delay on last attempt
                {
                    await Task.Delay(100);
                }
            }
        }
    }
    
    [JSInvokable]
    public void HandleKeyPress(string key)
    {
        // When dialogs are open, only handle Space to close them, block game shortcuts
        if (_showResultDialog || _showChallengeResultDialog || _showAddManualCardDialog || _showFailedHistoryDialog || _showWinnerDialog)
        {
            // Only allow Space to close result dialogs
            if ((_showResultDialog || _showChallengeResultDialog) && key == " ")
            {
                if (_showResultDialog)
                {
                    CloseResultDialog();
                }
                else if (_showChallengeResultDialog)
                {
                    CloseChallengeResultDialog();
                }
            }
            return; // Block all game shortcuts when dialogs are open
        }
        
        // Handle Space to advance to next player
        if (CurrentItem == null && _answerGiven && key == " ")
        {
            _ = NextPlayerTurn(); // Fire and forget
            return;
        }
        
        if (CurrentItem == null) return;
        
        // Handle Spotify shortcuts
        if (key == "w" || key == "W")
        {
            OpenSpotifyWeb();
            return;
        }
        if (key == "d" || key == "D")
        {
            OpenSpotifyDesktop();
            return;
        }
        
        // Challenge mode keyboard navigation
        if (_challengeMode && _challengedPlayer != null)
        {
            var challengePlacements = new List<(string key, QuizItem<T>? prev, QuizItem<T>? next)>();
            
            // Build placements for challenged player
            challengePlacements.Add(($"{_challengedPlayer.Name}_null", null, _challengedPlayer.Cards.FirstOrDefault()));
            
            for (int i = 0; i < _challengedPlayer.Cards.Count; i++)
            {
                var prev = _challengedPlayer.Cards[i];
                var next = i + 1 < _challengedPlayer.Cards.Count ? _challengedPlayer.Cards[i + 1] : null;
                
                if (next != null && Equals(prev.value, next.value))
                {
                    continue;
                }
                
                challengePlacements.Add(($"{_challengedPlayer.Name}_{prev.id}", prev, next));
            }
            
            if (challengePlacements.Count == 0) return;
            
            // Find original placement key
            var originalKey = challengePlacements.FirstOrDefault(p => 
                p.prev == _originalPlacementPrev && p.next == _originalPlacementNext).key;
            
            switch (key)
            {
                case "0":
                case "1":
                case "2":
                case "3":
                case "4":
                case "5":
                case "6":
                case "7":
                case "8":
                case "9":
                    var numIndex = int.Parse(key);
                    if (numIndex < challengePlacements.Count)
                    {
                        var selectedKey = challengePlacements[numIndex].key;
                        if (selectedKey == originalKey)
                        {
                            SnackBar.Add("Et voi valita samaa paikkaa kuin alkuperäinen vastaus!", Severity.Warning);
                        }
                        else
                        {
                            _selectedChallengePositionKey = selectedKey;
                            StateHasChanged();
                        }
                    }
                    break;
                case " ":
                case "Enter":
                    if (_selectedChallengePositionKey != null)
                    {
                        var selected = challengePlacements.FirstOrDefault(p => p.key == _selectedChallengePositionKey);
                        if (selected != default)
                        {
                            ConfirmChallenge(selected.prev, selected.next);
                        }
                    }
                    break;
            }
            return;
        }
        
        // Normal placement mode
        UpdateAvailablePlacements();
        
        if (_availablePlacements.Count == 0) return;
        
        switch (key)
        {
            case "0":
            case "1":
            case "2":
            case "3":
            case "4":
            case "5":
            case "6":
            case "7":
            case "8":
            case "9":
                var numIndex = int.Parse(key);
                if (numIndex >= _availablePlacements.Count)
                {
                    // Jos numero on liian iso, mene viimeiseen
                    _currentPlacementIndex = _availablePlacements.Count - 1;
                }
                else
                {
                    _currentPlacementIndex = numIndex;
                }
                UpdateActivePlacement();
                break;
            case "ArrowLeft":
                _currentPlacementIndex = (_currentPlacementIndex - 1 + _availablePlacements.Count) % _availablePlacements.Count;
                UpdateActivePlacement();
                break;
            case "ArrowRight":
                _currentPlacementIndex = (_currentPlacementIndex + 1) % _availablePlacements.Count;
                UpdateActivePlacement();
                break;
            case " ":
            case "Enter":
                if (_activePlacementKey != null && _currentPlacementIndex < _availablePlacements.Count)
                {
                    var placement = _availablePlacements[_currentPlacementIndex];
                    
                    // Tallenna alkuperäinen valinta ennen vahvistusta
                    if (placement.player == Game.CurrentPlayer && !_challengeMode)
                    {
                        _originalPlacementPrev = placement.prev;
                        _originalPlacementNext = placement.next;
                        
                        Console.WriteLine($"[Keyboard CONFIRM] Tallennettiin alkuperäinen valinta pelaajalle {placement.player.Name}:");
                        Console.WriteLine($"  prev: {(placement.prev != null ? placement.prev.value.ToString() : "null")}");
                        Console.WriteLine($"  next: {(placement.next != null ? placement.next.value.ToString() : "null")}");
                    }
                    
                    SetHere(placement.player, placement.prev, placement.next);
                }
                break;
        }
    }
    
    private void OpenSpotifyWeb()
    {
        if (CurrentItem != null && !string.IsNullOrEmpty(CurrentItem.Uri))
        {
            var trackId = CurrentItem.Uri.Split(':').Last();
            var spotifyWebUrl = $"https://open.spotify.com/track/{trackId}";
            JSRuntime.InvokeVoidAsync("open", spotifyWebUrl, "_blank");
        }
    }
    
    private void OpenSpotifyDesktop()
    {
        if (CurrentItem != null && !string.IsNullOrEmpty(CurrentItem.Uri))
        {
            JSRuntime.InvokeVoidAsync("open", CurrentItem.Uri, "_blank");
        }
    }
    
    private void UpdateAvailablePlacements()
    {
        _availablePlacements.Clear();
        
        var currentPlayer = Game.CurrentPlayer;
        if (currentPlayer == null) return;
        
        // First placement (before all cards)
        var firstKey = $"{currentPlayer.Name}_null";
        _availablePlacements.Add((firstKey, currentPlayer, null, currentPlayer.Cards.FirstOrDefault()));
        
        // Placements between and after cards
        for (int i = 0; i < currentPlayer.Cards.Count; i++)
        {
            var prev = currentPlayer.Cards[i];
            var next = i + 1 < currentPlayer.Cards.Count ? currentPlayer.Cards[i + 1] : null;
            
            // Skip if prev and next have same value (no point placing between same years)
            if (next != null && Equals(prev.value, next.value))
            {
                continue;
            }
            
            var key = $"{currentPlayer.Name}_{prev.id}";
            _availablePlacements.Add((key, currentPlayer, prev, next));
        }
        
        // Ensure current index is valid
        if (_currentPlacementIndex >= _availablePlacements.Count)
        {
            _currentPlacementIndex = 0;
        }
    }
    
    private void UpdateActivePlacement()
    {
        if (_availablePlacements.Count > 0 && _currentPlacementIndex < _availablePlacements.Count)
        {
            var placement = _availablePlacements[_currentPlacementIndex];
            _activePlacementKey = placement.key;
            _activePlacementPrev = placement.prev;
            _activePlacementNext = placement.next;
            
            Console.WriteLine($"[UpdateActivePlacement] Päivitettiin aktiivinen valinta:");
            Console.WriteLine($"  prev: {(_activePlacementPrev != null ? _activePlacementPrev.value.ToString() : "null")}");
            Console.WriteLine($"  next: {(_activePlacementNext != null ? _activePlacementNext.value.ToString() : "null")}");
            
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("removeKeyboardListener");
            }
            catch (JSException)
            {
                // Ignore if function doesn't exist
            }
            _dotNetRef.Dispose();
        }
    }

    private async Task UseRyostoSkipSong()
    {
        var currentPlayer = Game.CurrentPlayer;
        if (currentPlayer == null || currentPlayer.RyostoCards <= 0 || CurrentItem == null)
        {
            SnackBar.Add("Ei ryöstokortteja tai ei kappaletta!", Severity.Error);
            return;
        }

        currentPlayer.RyostoCards--;
        SnackBar.Add($"{currentPlayer.Name} käytti ryöstokortin! Uusi kappale tulossa...", Severity.Info);
        
        // Palauta nykyinen kappale takaisin pakaan
        if (CurrentItem != null)
        {
            Game.ReturnQuestion(CurrentItem);
        }
        
        await DrawNext();
        StateHasChanged();
    }

    private void UseRyostoTradeForCard()
    {
        var currentPlayer = Game.CurrentPlayer;
        if (currentPlayer == null || currentPlayer.RyostoCards < 3)
        {
            SnackBar.Add("Tarvitset 3 ryöstokorttia!", Severity.Error);
            return;
        }

        if (CurrentItem == null)
        {
            SnackBar.Add("Ei kappaletta pelattavana!", Severity.Error);
            return;
        }

        currentPlayer.RyostoCards -= 3;
        currentPlayer.AddCard(CurrentItem);
        currentPlayer.SortCards();
        
        SnackBar.Add($"{currentPlayer.Name} vaihtoi 3 ryöstokorttia kappaleeseen!", Severity.Success);
        
        CurrentItem = null;
        _answerGiven = true;
        StateHasChanged();
    }

    private void StartChallenge(Player<T> challenger)
    {
        if (challenger.RyostoCards < 1)
        {
            SnackBar.Add("Tarvitset 1 ryöstokortin haastaaksesi!", Severity.Error);
            return;
        }

        var activePlayer = Game.CurrentPlayer;
        if (activePlayer == null || activePlayer == challenger)
        {
            SnackBar.Add("Et voi haastaa itseäsi!", Severity.Error);
            return;
        }

        // Tallenna alkuperäisen pelaajan valinta ennen haasteen alkamista
        _originalPlacementPrev = _activePlacementPrev;
        _originalPlacementNext = _activePlacementNext;
        
        Console.WriteLine($"[StartChallenge] Tallennettiin alkuperäinen valinta:");
        Console.WriteLine($"  prev: {(_originalPlacementPrev != null ? _originalPlacementPrev.value.ToString() : "null")}");
        Console.WriteLine($"  next: {(_originalPlacementNext != null ? _originalPlacementNext.value.ToString() : "null")}");

        _challengeMode = true;
        _challengingPlayer = challenger;
        _challengedPlayer = activePlayer;
        _selectedChallengePositionKey = null;
        
        SnackBar.Add($"{challenger.Name} haastaa pelaajan {activePlayer.Name}! Valitse oikea positio kortille.", Severity.Info);
        StateHasChanged();
    }

    private void SelectChallengePosition(string positionKey)
    {
        if (_challengedPlayer == null) return;
        
        // Build challenge placements list
        var challengePlacements = new List<(string key, QuizItem<T>? prev, QuizItem<T>? next)>();
        challengePlacements.Add(($"{_challengedPlayer.Name}_null", null, _challengedPlayer.Cards.FirstOrDefault()));
        
        for (int i = 0; i < _challengedPlayer.Cards.Count; i++)
        {
            var prev = _challengedPlayer.Cards[i];
            var next = i + 1 < _challengedPlayer.Cards.Count ? _challengedPlayer.Cards[i + 1] : null;
            
            if (next != null && Equals(prev.value, next.value))
            {
                continue;
            }
            
            challengePlacements.Add(($"{_challengedPlayer.Name}_{prev.id}", prev, next));
        }
        
        // Check if this is the same position as the original answer
        var selectedPlacement = challengePlacements.FirstOrDefault(p => p.key == positionKey);
        var originalPlacement = challengePlacements.FirstOrDefault(p => 
            p.prev == _originalPlacementPrev && p.next == _originalPlacementNext);
        
        Console.WriteLine($"[SelectChallengePosition] Tarkistetaan:");
        Console.WriteLine($"  Selected key: {positionKey}");
        Console.WriteLine($"  Original key: {(originalPlacement != default ? originalPlacement.key : "NULL/NOT FOUND")}");
        Console.WriteLine($"  Original prev: {(_originalPlacementPrev != null ? _originalPlacementPrev.value.ToString() : "null")}");
        Console.WriteLine($"  Original next: {(_originalPlacementNext != null ? _originalPlacementNext.value.ToString() : "null")}");
        
        if (originalPlacement != default && positionKey == originalPlacement.key)
        {
            SnackBar.Add("Et voi valita samaa paikkaa kuin alkuperäinen vastaus!", Severity.Warning);
            return;
        }
        
        if (_selectedChallengePositionKey == positionKey)
        {
            // Second click - confirm challenge
            ConfirmChallenge(selectedPlacement.prev, selectedPlacement.next);
        }
        else
        {
            // First click - select position
            _selectedChallengePositionKey = positionKey;
            StateHasChanged();
        }
    }

    private void ConfirmChallenge(QuizItem<T>? prev, QuizItem<T>? next)
    {
        if (_challengingPlayer == null || _challengedPlayer == null || CurrentItem == null)
        {
            CancelChallenge();
            return;
        }

        // Use ryöstö card
        _challengingPlayer.RyostoCards--;

        // Check both guesses
        var challengerCorrect = _challengingPlayer.CheckOrderGuess(CurrentItem, prev, next);
        var originalCorrect = _challengedPlayer.CheckOrderGuess(CurrentItem, _originalPlacementPrev, _originalPlacementNext);

        // Debug logging
        Console.WriteLine($"=== CHALLENGE DEBUG ===");
        Console.WriteLine($"Challenger: {_challengingPlayer.Name}");
        Console.WriteLine($"  - Placement: {(prev != null ? prev.value.ToString() : "null")} to {(next != null ? next.value.ToString() : "null")}");
        Console.WriteLine($"  - Result: {challengerCorrect}");
        Console.WriteLine($"Challenged (Original): {_challengedPlayer.Name}");
        Console.WriteLine($"  - Placement: {(_originalPlacementPrev != null ? _originalPlacementPrev.value.ToString() : "null")} to {(_originalPlacementNext != null ? _originalPlacementNext.value.ToString() : "null")}");
        Console.WriteLine($"  - Result: {originalCorrect}");
        Console.WriteLine($"======================");

        // Tallenna tiedot dialogia varten
        _lastAnswerText = CurrentItem.text ?? "";
        _lastAnswerValue = CurrentItem.value?.ToString() ?? "";
        _lastAnswerUri = CurrentItem.Uri ?? "";
        _lastAnswerItem = CurrentItem;
        
        // Challenge-specific data
        _challengerWasCorrect = challengerCorrect;
        _challengedWasCorrect = originalCorrect;
        _lastChallengerPlayer = _challengingPlayer;
        _lastChallengedPlayer = _challengedPlayer;
        _lastChallengerValue = CurrentItem.value?.ToString() ?? "";
        _lastChallengedValue = CurrentItem.value?.ToString() ?? "";
        _lastChallengerPrev = prev;
        _lastChallengerNext = next;
        _lastChallengedPrev = _originalPlacementPrev;
        _lastChallengedNext = _originalPlacementNext;

        // Determine winner
        // Jos alkuperäinen on oikein, hän voittaa AINA (vaikka haastaja olisi myös oikein)
        if (originalCorrect)
        {
            // Original player wins - gets the card
            _challengedPlayer.AddCard(CurrentItem);
            _challengedPlayer.SortCards();
            _lastAnswerCorrect = true;
            _lastAnswerPlayer = _challengedPlayer;
        }
        else if (challengerCorrect)
        {
            // Challenger wins - gets the card (only if original was wrong)
            _challengingPlayer.AddCard(CurrentItem);
            _challengingPlayer.SortCards();
            _lastAnswerCorrect = true;
            _lastAnswerPlayer = _challengingPlayer;
        }
        else
        {
            // Both wrong - nobody gets the card
            _challengedPlayer.AddFailedCard(CurrentItem);
            _lastAnswerCorrect = false;
            _lastAnswerPlayer = _challengedPlayer;
        }

        // Show challenge result dialog instead of regular result
        _showChallengeResultDialog = true;
        _guessedArtistAndSong = false;
        CurrentItem = null;
        _answerGiven = true;
        _activePlacementKey = null;
        
        // Clear challenge state after showing dialog
        _challengeMode = false;
        _challengingPlayer = null;
        _challengedPlayer = null;
        _selectedChallengePositionKey = null;
        _originalPlacementPrev = null;
        _originalPlacementNext = null;
        
        StateHasChanged();
    }

    private void CancelChallenge()
    {
        _challengeMode = false;
        _challengingPlayer = null;
        _challengedPlayer = null;
        _selectedChallengePositionKey = null;
        SnackBar.Add("Haaste peruttu!", Severity.Info);
        StateHasChanged();
    }

    private void SelectDecade(int decade)
    {
        _selectedDecade = decade;
        StateHasChanged();
    }

    private void ConfirmDecadeGuess()
    {
        var currentPlayer = Game.CurrentPlayer;
        if (currentPlayer == null || CurrentItem == null || !_selectedDecade.HasValue)
        {
            return;
        }

        var isCorrect = currentPlayer.CheckDecadeGuess(CurrentItem, _selectedDecade.Value);

        // Tallenna vastauksen tiedot dialogia varten
        _lastAnswerCorrect = isCorrect;
        _lastAnswerText = CurrentItem.text ?? "";
        _lastAnswerValue = CurrentItem.value?.ToString() ?? "";
        _lastAnswerUri = CurrentItem.Uri ?? "";
        _lastAnswerItem = CurrentItem;
        _lastAnswerPlayer = currentPlayer;
        _lastAnswerPrev = null;
        _lastAnswerNext = null;

        if (isCorrect)
        {
            currentPlayer.AddCard(CurrentItem);
            currentPlayer.SortCards();
        }
        else
        {
            currentPlayer.AddFailedCard(CurrentItem);
        }

        // Näytä iso dialogi tuloksesta
        _showResultDialog = true;
        _guessedArtistAndSong = false;
        CurrentItem = null;
        _answerGiven = true;
        _selectedDecade = null;
        StateHasChanged();
    }

    private Task DrawNext()
    {
        CurrentItem = Game.GetRandomQuestion();
        _answerGiven = false;
        _activePlacementKey = null;
        _currentPlacementIndex = 0;
        UpdateAvailablePlacements();
        return Task.CompletedTask;
    }
    
    private Task TogglePlacement(Player<T> player, string placementKey, QuizItem<T>? prev, QuizItem<T>? next)
    {
        if (_activePlacementKey == placementKey)
        {
            // Second click - tallenna alkuperäinen valinta ja vahvista
            if (player == Game.CurrentPlayer && !_challengeMode)
            {
                _originalPlacementPrev = prev;
                _originalPlacementNext = next;
                
                // Debug
                Console.WriteLine($"[TogglePlacement CONFIRM] Tallennettiin alkuperäinen valinta pelaajalle {player.Name}:");
                Console.WriteLine($"  prev: {(prev != null ? prev.value.ToString() : "null")}");
                Console.WriteLine($"  next: {(next != null ? next.value.ToString() : "null")}");
            }
            
            // Make the guess
            SetHere(player, prev, next);
        }
        else
        {
            // First click - tallenna valinta (voi vaihtua ennen vahvistusta)
            _activePlacementKey = placementKey;
            _activePlacementPrev = prev;
            _activePlacementNext = next;
            
            Console.WriteLine($"[TogglePlacement SELECT] Valittiin paikka:");
            Console.WriteLine($"  prev: {(prev != null ? prev.value.ToString() : "null")}");
            Console.WriteLine($"  next: {(next != null ? next.value.ToString() : "null")}");
            
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private Task SetHere(Player<T> player, QuizItem<T>? prev, QuizItem<T>? next)
    {
        if (CurrentItem is null)
        {
            return Task.CompletedTask;
        }

        var result = player.CheckOrderGuess(CurrentItem, prev, next);

        // Tallenna vastauksen tiedot dialogia varten
        _lastAnswerCorrect = result;
        _lastAnswerText = CurrentItem.text ?? "";
        _lastAnswerValue = CurrentItem.value?.ToString() ?? "";
        _lastAnswerUri = CurrentItem.Uri ?? "";
        _lastAnswerItem = CurrentItem;
        _lastAnswerPlayer = player;
        _lastAnswerPrev = prev;
        _lastAnswerNext = next;

        if (result)
        {
            player.AddCard(CurrentItem);
            player.SortCards();
        }
        else
        {
            player.AddFailedCard(CurrentItem);
        }

        // Näytä iso dialogi tuloksesta
        _showResultDialog = true;
        _guessedArtistAndSong = false;
        CurrentItem = null;
        _answerGiven = true;
        _activePlacementKey = null;
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private void StartEditValue()
    {
        _editedValue = _lastAnswerValue;
        _isEditingValue = true;
        StateHasChanged();
    }
    
    private void CancelEditValue()
    {
        _isEditingValue = false;
        StateHasChanged();
    }
    
    private void SaveEditedValue()
    {
        if (_lastAnswerItem == null || _lastAnswerPlayer == null)
        {
            _isEditingValue = false;
            StateHasChanged();
            return;
        }

        // Try to parse the edited value
        try
        {
            var converter = System.ComponentModel.TypeDescriptor.GetConverter(typeof(T));
            if (converter != null && converter.CanConvertFrom(typeof(string)))
            {
                var newValue = (T?)converter.ConvertFromString(_editedValue);
                if (newValue != null)
                {
                    _lastAnswerItem.value = newValue;
                    _lastAnswerValue = _editedValue;
                    
                    // Recheck the answer
                    var newResult = _lastAnswerPlayer.CheckOrderGuess(_lastAnswerItem, _lastAnswerPrev, _lastAnswerNext);
                    
                    if (newResult != _lastAnswerCorrect)
                    {
                        // Answer changed from wrong to correct or vice versa
                        if (newResult)
                        {
                            // Now correct - move from failed to cards
                            _lastAnswerPlayer.FailedCards.Remove(_lastAnswerItem);
                            _lastAnswerPlayer.AddCard(_lastAnswerItem);
                            _lastAnswerPlayer.SortCards();
                        }
                        else
                        {
                            // Now incorrect - move from cards to failed
                            _lastAnswerPlayer.Cards.Remove(_lastAnswerItem);
                            _lastAnswerPlayer.AddFailedCard(_lastAnswerItem);
                        }
                        
                        _lastAnswerCorrect = newResult;
                    }
                }
            }
        }
        catch
        {
            // If parsing fails, just cancel
        }
        
        _isEditingValue = false;
        StateHasChanged();
    }
    
    private void CloseResultDialog()
    {
        // Tarkista oliko artisti & kappale arvaus oikein
        if (_guessedArtistAndSong && _lastAnswerPlayer != null && Game.UseRyostoCards)
        {
            _lastAnswerPlayer.RyostoCards++;
            SnackBar.Add($"🎤 {_lastAnswerPlayer.Name} arvasi myös artisti & kappaleen ja sai ryöstokortin!", Severity.Success);
        }
        
        _showResultDialog = false;
        _guessedArtistAndSong = false;
        StateHasChanged();
    }
    
    private void CloseChallengeResultDialog()
    {
        // Tarkista oliko artisti & kappale arvaus oikein (alkuperäiselle pelaajalle)
        if (_guessedArtistAndSong && _lastChallengedPlayer != null && Game.UseRyostoCards)
        {
            _lastChallengedPlayer.RyostoCards++;
            SnackBar.Add($"🎤 {_lastChallengedPlayer.Name} arvasi myös artisti & kappaleen ja sai ryöstokortin!", Severity.Success);
        }
        
        _showChallengeResultDialog = false;
        _guessedArtistAndSong = false;
        _isEditingValue = false;
        StateHasChanged();
    }
    
    private void SaveEditedChallengeValue()
    {
        try
        {
            if (_lastAnswerItem != null && _lastChallengerPlayer != null && _lastChallengedPlayer != null)
            {
                var newValue = (T)Convert.ChangeType(_editedValue, typeof(T));
                if (newValue != null)
                {
                    _lastAnswerItem.value = newValue;
                    _lastAnswerValue = _editedValue;
                    _lastChallengerValue = _editedValue;
                    _lastChallengedValue = _editedValue;
                    
                    // Recheck both answers
                    var challengerNewResult = _lastChallengerPlayer.CheckOrderGuess(_lastAnswerItem, _lastChallengerPrev, _lastChallengerNext);
                    var challengedNewResult = _lastChallengedPlayer.CheckOrderGuess(_lastAnswerItem, _lastChallengedPrev, _lastChallengedNext);
                    
                    // Remove card from previous winner
                    if (_lastAnswerPlayer != null)
                    {
                        _lastAnswerPlayer.Cards.Remove(_lastAnswerItem);
                        _lastAnswerPlayer.FailedCards.Remove(_lastAnswerItem);
                    }
                    
                    // Update results
                    _challengerWasCorrect = challengerNewResult;
                    _challengedWasCorrect = challengedNewResult;
                    
                    // Determine new winner (alkuperäinen voittaa jos molemmat oikein)
                    if (challengedNewResult)
                    {
                        _lastChallengedPlayer.AddCard(_lastAnswerItem);
                        _lastChallengedPlayer.SortCards();
                        _lastAnswerPlayer = _lastChallengedPlayer;
                        _lastAnswerCorrect = true;
                    }
                    else if (challengerNewResult)
                    {
                        _lastChallengerPlayer.AddCard(_lastAnswerItem);
                        _lastChallengerPlayer.SortCards();
                        _lastAnswerPlayer = _lastChallengerPlayer;
                        _lastAnswerCorrect = true;
                    }
                    else
                    {
                        _lastChallengedPlayer.AddFailedCard(_lastAnswerItem);
                        _lastAnswerPlayer = _lastChallengedPlayer;
                        _lastAnswerCorrect = false;
                    }
                }
            }
        }
        catch
        {
            // If parsing fails, just cancel
        }
        
        _isEditingValue = false;
        StateHasChanged();
    }
    
    private void ShowFailedCardsHistory(Player<T> player)
    {
        _selectedPlayer = player;
        _showFailedHistoryDialog = true;
        StateHasChanged();
    }
    
    private void CloseFailedHistoryDialog()
    {
        _showFailedHistoryDialog = false;
        _selectedPlayer = null;
        StateHasChanged();
    }
    
    private void ShowWinnerCelebration()
    {
        _celebrationTrackId = Configuration["CelebrationSong:TrackId"];
        Console.WriteLine(_celebrationTrackId);
        _celebrationTrackId = _celebrationTrackId ?? "7nwLYNM1LQWwwHLiHcm6Ai"; // fix, ei toimi Configuration jostain syystä?
        _showWinnerDialog = true;
        StateHasChanged();
    }
    
    private void CloseWinnerDialog()
    {
        _showWinnerDialog = false;
        StateHasChanged();
    }
    
    // Pelinjohtajan työkalut
    private void AdjustRyostoCards(Player<T> player, int amount)
    {
        player.RyostoCards = Math.Max(0, player.RyostoCards + amount);
        var action = amount > 0 ? "lisätty" : "poistettu";
        SnackBar.Add($"Ryöstokortti {action}: {player.Name} ({player.RyostoCards} kpl)", Severity.Info);
        StateHasChanged();
    }
    
    private void ShowAddManualCard(Player<T> player)
    {
        _manualCardPlayer = player;
        _manualCardValue = "";
        _showAddManualCardDialog = true;
        StateHasChanged();
    }
    
    private string FormatPlacementRange(QuizItem<T>? prev, QuizItem<T>? next)
    {
        if (prev == null && next == null)
        {
            return "(tyhjä aikajana)";
        }
        else if (prev == null && next != null)
        {
            return $"-{next.value}";
        }
        else if (prev != null && next == null)
        {
            return $"{prev.value}-";
        }
        else if (prev != null && next != null)
        {
            return $"{prev.value}-{next.value}";
        }
        return "";
    }
    
    private void CancelAddManualCard()
    {
        _showAddManualCardDialog = false;
        _manualCardPlayer = null;
        _manualCardValue = "";
        StateHasChanged();
    }
    
    private void ConfirmAddManualCard()
    {
        if (_manualCardPlayer == null || string.IsNullOrWhiteSpace(_manualCardValue))
        {
            SnackBar.Add("Syötä vuosiluku!", Severity.Warning);
            return;
        }
        
        try
        {
            // Parse value as type T
            var parsedValue = (T)Convert.ChangeType(_manualCardValue, typeof(T));
            
            // Create manual card
            var manualCard = new QuizItem<T>
            {
                id = Guid.NewGuid().ToString(),
                text = $"Manuaalinen kortti ({_manualCardValue})",
                value = parsedValue,
                Uri = null
            };
            
            _manualCardPlayer.AddCard(manualCard);
            _manualCardPlayer.SortCards();
            
            SnackBar.Add($"Kortti lisätty: {_manualCardPlayer.Name} ({_manualCardValue})", Severity.Success);
            
            _showAddManualCardDialog = false;
            _manualCardPlayer = null;
            _manualCardValue = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Virhe arvon käsittelyssä: {ex.Message}", Severity.Error);
        }
    }

    private async Task NextPlayerTurn()
    {
        Game.NextPlayer();
        await DrawNext();
        _answerGiven = false;
        StateHasChanged();
    }

}
