@using MathGame.Web.Models.Quiz
@typeparam T where T : IComparable<T>
@inject ISnackbar SnackBar


<MudPaper Elevation="4" Class="p-4 mb-4">
    <MudText Typo="Typo.h2"> @Game.QuizTitle</MudText>
    <MudText Typo="Typo.subtitle1"> @Game.QuizDescription</MudText>
    <MudText>Kortteja jäljellä: @Game.TotalQuestionsLeft / @Game.TotalQuestions</MudText>
</MudPaper>

@* Nykyisen kappaleen alue *@
@if (CurrentItem is not null && !string.IsNullOrEmpty(CurrentItem.Uri))
{
    var trackId = CurrentItem.Uri.Split(':').Last();
    var spotifyWebUrl = $"https://open.spotify.com/track/{trackId}";
    var spotifyDesktopUrl = CurrentItem.Uri;
    var qrCodeUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={Uri.EscapeDataString(spotifyWebUrl)}";

    <MudPaper Elevation="4" Class="p-4 mb-4">
        <MudText Typo="Typo.h5" Class="mb-3">🎵 Nykyinen kappale</MudText>

        <MudGrid>
            <MudItem xs="12" md="8">
                <MudText Typo="Typo.body2" Class="mb-2">Avaa Spotify kuunnellaksesi kappaletta:</MudText>

                <MudStack Row Class="mt-2" Spacing="2">
                    <MudButton
                        Href="@spotifyWebUrl"
                        Target="_blank"
                        Variant="Variant.Filled"
                        Color="Color.Success"
                        StartIcon="@Icons.Material.Filled.Language">
                        Spotify Web
                    </MudButton>

                    <MudButton
                        Href="@spotifyDesktopUrl"
                        Target="_blank"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.DesktopWindows">
                        Spotify Desktop
                    </MudButton>
                </MudStack>

                <MudText Typo="Typo.caption" Class="mt-3" Color="Color.Info">
                    💡 Vinkki: Käytä Spotify Web -linkkiä mobiililaitteilla tai Spotify Desktop -linkkiä tietokoneella.
                </MudText>
            </MudItem>

            <MudItem xs="12" md="4" Class="d-flex flex-column align-center">
                <MudText Typo="Typo.body2" Class="mb-2">Tai skannaa QR-koodi:</MudText>
                <MudImage Src="@qrCodeUrl" Alt="QR Code for Spotify" Width="200" Height="200" Class="rounded" />
            </MudItem>
        </MudGrid>
    </MudPaper>
}

@* Pelaajat riveittäin *@
@foreach (var player in Game.Players)
{
    var isActivePlayer = Game.CurrentPlayer == player;
    var elevation = isActivePlayer ? 8 : 2;
    var borderColor = isActivePlayer ? "border-left: 4px solid var(--mud-palette-primary);" : "";

    <MudPaper Elevation="@elevation" Class="p-4 mb-3" Style="@borderColor">
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6">
                    @player.Name
                    @if (isActivePlayer)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Vuorossa</MudChip>
                    }
                </MudText>
                <MudText Color="Color.Success">Pisteet: @player.Cards.Count</MudText>
                @if (player.FailedCards.Count > 0)
                {
                    <MudText Color="Color.Error">Väärät: @player.FailedCards.Count</MudText>
                }
            </MudStack>
        </MudStack>

        @* Pelaajan kortit horisontaalisesti *@
        <MudStack Row Class="mt-3" Style="overflow-x: auto; flex-wrap: nowrap;">
            @* Aseta tähän -painike ennen ensimmäistä korttia *@
            @if (isActivePlayer && CurrentItem is not null)
            {
                <MudButton
                    OnClick="() => SetHere(player, null, player.Cards.FirstOrDefault())"
                    Variant="Variant.Outlined"
                    Color="Color.Primary"
                    Style="min-width: 80px; height: 120px;">
                    Aseta<br/>Tähän
                </MudButton>
            }

            @if (player.Cards.Count == 0)
            {
                <MudText Color="Color.Tertiary" Class="align-self-center">Ei vielä kortteja</MudText>
            }
            else
            {
                for (int i = 0; i < player.Cards.Count; i++)
                {
                    var item = player.Cards[i];
                    var cardIndex = i;

                    <MudCard Style="min-width: 150px; max-width: 150px;">
                        <MudCardContent>
                            <MudText Typo="Typo.h4" Align="Align.Center">@item.value</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center" Style="font-size: 0.75rem;">@item.text</MudText>
                        </MudCardContent>
                    </MudCard>

                    @* Aseta tähän -painike korttien välissä *@
                    @if (isActivePlayer && CurrentItem is not null)
                    {
                        var prev = player.Cards[cardIndex];
                        var next = cardIndex + 1 < player.Cards.Count ? player.Cards[cardIndex + 1] : null;

                        <MudButton
                            OnClick="() => SetHere(player, prev, next)"
                            Variant="Variant.Outlined"
                            Color="Color.Primary"
                            Style="min-width: 80px; height: 120px;">
                            Aseta<br/>Tähän
                        </MudButton>
                    }
                }
            }
        </MudStack>
    </MudPaper>
}

@* Seuraava pelaaja -painike *@
@if (CurrentItem is null && _answerGiven)
{
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NextPlayerTurn" FullWidth="true" Size="Size.Large">
        Seuraava pelaaja
    </MudButton>
}


@code {
    [Parameter] public required QuizGame<T> Game { get; set; }

    private QuizItem<T>? CurrentItem;
    private bool _answerGiven = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            if (Game is null)
            {
                throw new ArgumentNullException(nameof(Game), "Game parameter must be set.");
            }

            if (Game.Players.Count == 0)
            {
                throw new InvalidOperationException("At least one player must be added to the game before starting.");
            }

            foreach (var gamePlayer in Game.Players)
            {
                if (gamePlayer.Cards.Count() == 0)
                {
                    // If player has no cards, draw a card for them
                    var item = Game.GetRandomQuestion();
                    if (item is not null)
                    {
                        gamePlayer.AddCard(item);
                        gamePlayer.SortCards();
                    }
                }
            }

            // Nosta ensimmäinen kortti ensimmäiselle pelaajalle
            await DrawNext();
            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private Task DrawNext()
    {
        CurrentItem = Game.GetRandomQuestion();
        _answerGiven = false;
        return Task.CompletedTask;
    }

    private Task SetHere(Player<T> player, QuizItem<T>? prev, QuizItem<T>? next)
    {
        if (CurrentItem is null)
        {
            return Task.CompletedTask;
        }

        var result = player.CheckOrderGuess(CurrentItem, prev, next);

        if (result)
        {
            player.AddCard(CurrentItem);
            player.SortCards();
            SnackBar.Add($"Oikein! Kortti: {CurrentItem.text} (Arvo: {CurrentItem.value})", Severity.Success);
        }
        else
        {
            SnackBar.Add($"Väärin! Kortti: {CurrentItem.text} (Arvo: {CurrentItem.value})", Severity.Error);
            player.AddFailedCard(CurrentItem);
        }

        CurrentItem = null;
        _answerGiven = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task NextPlayerTurn()
    {
        Game.NextPlayer();
        await DrawNext();
        _answerGiven = false;
        StateHasChanged();
    }

}
