@using MathGame.Web.Models.Quiz
@using MathGame.Web.Services
@typeparam T where T : IComparable<T>
@inject ISnackbar SnackBar
@inject SpotifyService SpotifyService


<MudPaper Elevation="4" Class="p-4 mb-4">
    <MudText Typo="Typo.h2"> @Game.QuizTitle</MudText>
    <MudText Typo="Typo.subtitle1"> @Game.QuizDescription</MudText>
    <MudText>Kortteja jäljellä: @Game.TotalQuestionsLeft / @Game.TotalQuestions</MudText>

    @* Spotify Authentication *@
    <MudPaper Elevation="2" Class="p-3 mt-3">
        <MudText Typo="Typo.h6" Class="mb-2">Spotify Autentikointi</MudText>
        @if (string.IsNullOrEmpty(_accessToken))
        {
            <MudStack Spacing="2">
                <MudTextField @bind-Value="_clientId" Label="Client ID" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="_clientSecret" Label="Client Secret" Variant="Variant.Outlined" InputType="InputType.Password" />
                <MudButton OnClick="AuthenticateSpotify" Variant="Variant.Filled" Color="Color.Success" Disabled="@_isAuthenticating">
                    @if (_isAuthenticating)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ml-2">Autentikoidaan...</MudText>
                    }
                    else
                    {
                        <MudText>Hae Access Token</MudText>
                    }
                </MudButton>
            </MudStack>
        }
        else
        {
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                <MudText Color="Color.Success">Autentikoitu onnistuneesti</MudText>
            </MudStack>
        }
    </MudPaper>

    @* Spotify device selection *@
    @if (!string.IsNullOrEmpty(_accessToken))
    {
        <MudStack Row Class="mt-3" AlignItems="AlignItems.Center">
            <MudButton OnClick="LoadDevices" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">
                Päivitä laitteet
            </MudButton>
            @if (_devices != null && _devices.Length > 0)
            {
                <MudSelect T="string" @bind-Value="_selectedDeviceId" Label="Valitse Spotify laite" Variant="Variant.Outlined" Dense="true">
                    @foreach (var device in _devices)
                    {
                        <MudSelectItem T="string" Value="@device.Id">@device.Name (@device.Type)</MudSelectItem>
                    }
                </MudSelect>
                <MudCheckBox @bind-Value="_autoPlay" Label="Automaattinen soitto" Color="Color.Primary" />
            }
            else
            {
                <MudText Color="Color.Warning" Typo="Typo.body2">Ei laitteita saatavilla. Varmista että Spotify on käynnissä.</MudText>
            }
        </MudStack>
    }
</MudPaper>

@* Nykyisen kappaleen alue *@
@if (CurrentItem is not null && !string.IsNullOrEmpty(CurrentItem.Uri))
{
    var songAutoplayUrl = CurrentItem.Uri + "?autoplay=1";
    <MudPaper Elevation="4" Class="p-4 mb-4">
        <MudText Typo="Typo.h5">Nykyinen kappale</MudText>
        <MudStack Row Class="mt-2">
            <MudButton Href="@($"https://open.spotify.com/track/{CurrentItem.Uri.Split(':').Last()}")" Target="_blank" Disabled="CurrentItem.Uri == null" Variant="Variant.Filled" Color="Color.Primary">Avaa Spotify Webissä</MudButton>
            <MudButton Href="@songAutoplayUrl" Target="_blank" Disabled="CurrentItem.Uri == null" Variant="Variant.Filled" Color="Color.Secondary">Avaa Spotify Desktopissa</MudButton>
        </MudStack>
    </MudPaper>
}

@* Pelaajat riveittäin *@
@foreach (var player in Game.Players)
{
    var isActivePlayer = Game.CurrentPlayer == player;
    var elevation = isActivePlayer ? 8 : 2;
    var borderColor = isActivePlayer ? "border-left: 4px solid var(--mud-palette-primary);" : "";

    <MudPaper Elevation="@elevation" Class="p-4 mb-3" Style="@borderColor">
        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6">
                    @player.Name
                    @if (isActivePlayer)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Vuorossa</MudChip>
                    }
                </MudText>
                <MudText Color="Color.Success">Pisteet: @player.Cards.Count</MudText>
                @if (player.FailedCards.Count > 0)
                {
                    <MudText Color="Color.Error">Väärät: @player.FailedCards.Count</MudText>
                }
            </MudStack>
        </MudStack>

        @* Pelaajan kortit horisontaalisesti *@
        <MudStack Row Class="mt-3" Style="overflow-x: auto; flex-wrap: nowrap;">
            @* Aseta tähän -painike ennen ensimmäistä korttia *@
            @if (isActivePlayer && CurrentItem is not null)
            {
                <MudButton
                    OnClick="() => SetHere(player, null, player.Cards.FirstOrDefault())"
                    Variant="Variant.Outlined"
                    Color="Color.Primary"
                    Style="min-width: 80px; height: 120px;">
                    Aseta<br/>Tähän
                </MudButton>
            }

            @if (player.Cards.Count == 0)
            {
                <MudText Color="Color.Tertiary" Class="align-self-center">Ei vielä kortteja</MudText>
            }
            else
            {
                for (int i = 0; i < player.Cards.Count; i++)
                {
                    var item = player.Cards[i];
                    var cardIndex = i;

                    <MudCard Style="min-width: 150px; max-width: 150px;">
                        <MudCardContent>
                            <MudText Typo="Typo.h4" Align="Align.Center">@item.value</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center" Style="font-size: 0.75rem;">@item.text</MudText>
                        </MudCardContent>
                    </MudCard>

                    @* Aseta tähän -painike korttien välissä *@
                    @if (isActivePlayer && CurrentItem is not null)
                    {
                        var prev = player.Cards[cardIndex];
                        var next = cardIndex + 1 < player.Cards.Count ? player.Cards[cardIndex + 1] : null;

                        <MudButton
                            OnClick="() => SetHere(player, prev, next)"
                            Variant="Variant.Outlined"
                            Color="Color.Primary"
                            Style="min-width: 80px; height: 120px;">
                            Aseta<br/>Tähän
                        </MudButton>
                    }
                }
            }
        </MudStack>
    </MudPaper>
}

@* Seuraava pelaaja -painike *@
@if (CurrentItem is null && _answerGiven)
{
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NextPlayerTurn" FullWidth="true" Size="Size.Large">
        Seuraava pelaaja
    </MudButton>
}

@code {
    [Parameter] public required QuizGame<T> Game { get; set; }

    private QuizItem<T>? CurrentItem;
    private bool _answerGiven = false;
    private Device[]? _devices;
    private string? _selectedDeviceId;
    private bool _autoPlay = true;

    // Spotify authentication fields
    private string _clientId = "";
    private string _clientSecret = "";
    private string _accessToken = "";
    private bool _isAuthenticating = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            if (Game is null)
            {
                throw new ArgumentNullException(nameof(Game), "Game parameter must be set.");
            }

            if (Game.Players.Count == 0)
            {
                throw new InvalidOperationException("At least one player must be added to the game before starting.");
            }

            foreach (var gamePlayer in Game.Players)
            {
                if (gamePlayer.Cards.Count() == 0)
                {
                    // If player has no cards, draw a card for them
                    var item = Game.GetRandomQuestion();
                    if (item is not null)
                    {
                        gamePlayer.AddCard(item);
                        gamePlayer.SortCards();
                    }
                }
            }

            // Nosta ensimmäinen kortti ensimmäiselle pelaajalle
            await DrawNext();
            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task AuthenticateSpotify()
    {
        if (string.IsNullOrWhiteSpace(_clientId) || string.IsNullOrWhiteSpace(_clientSecret))
        {
            SnackBar.Add("Syötä Client ID ja Client Secret", Severity.Warning);
            return;
        }

        _isAuthenticating = true;
        StateHasChanged();

        try
        {
            var tokenResponse = await SpotifyService.AuthenticateAsync(_clientId, _clientSecret);

            if (tokenResponse != null && !string.IsNullOrEmpty(tokenResponse.AccessToken))
            {
                _accessToken = tokenResponse.AccessToken;
                SnackBar.Add("Autentikointi onnistui!", Severity.Success);

                // Automatically load devices after successful authentication
                await LoadDevices();
            }
            else
            {
                SnackBar.Add("Autentikointi epäonnistui. Tarkista Client ID ja Client Secret.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Virhe autentikoinnissa: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAuthenticating = false;
            StateHasChanged();
        }
    }

    private async Task LoadDevices()
    {
        try
        {
            var devicesResponse = await SpotifyService.GetAvailableDevicesAsync();
            _devices = devicesResponse?.Devices;

            if (_devices != null && _devices.Length > 0)
            {
                // Select the first active device or just the first device
                var activeDevice = _devices.FirstOrDefault(d => d.Is_Active);
                _selectedDeviceId = activeDevice?.Id ?? _devices.First().Id;
                SnackBar.Add($"Löydettiin {_devices.Length} laitetta", Severity.Success);
            }
            else
            {
                SnackBar.Add("Ei laitteita saatavilla. Käynnistä Spotify.", Severity.Warning);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Virhe ladattaessa laitteita: {ex.Message}", Severity.Error);
        }
    }

    private async Task DrawNext()
    {
        CurrentItem = Game.GetRandomQuestion();
        _answerGiven = false;

        // Automaattinen soitto jos käytössä
        if (_autoPlay && CurrentItem != null && !string.IsNullOrEmpty(CurrentItem.Uri) && !string.IsNullOrEmpty(_selectedDeviceId))
        {
            try
            {
                var success = await SpotifyService.PlayTrackAsync(CurrentItem.Uri, _selectedDeviceId);
                if (!success)
                {
                    SnackBar.Add("Kappaleen soitto epäonnistui", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                SnackBar.Add($"Virhe soittaessa kappaletta: {ex.Message}", Severity.Error);
            }
        }
    }

    private Task SetHere(Player<T> player, QuizItem<T>? prev, QuizItem<T>? next)
    {
        if (CurrentItem is null)
        {
            return Task.CompletedTask;
        }

        var result = player.CheckOrderGuess(CurrentItem, prev, next);

        if (result)
        {
            player.AddCard(CurrentItem);
            player.SortCards();
            SnackBar.Add($"Oikein! Kortti: {CurrentItem.text} (Arvo: {CurrentItem.value})", Severity.Success);
        }
        else
        {
            SnackBar.Add($"Väärin! Kortti: {CurrentItem.text} (Arvo: {CurrentItem.value})", Severity.Error);
            player.AddFailedCard(CurrentItem);
        }

        CurrentItem = null;
        _answerGiven = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task NextPlayerTurn()
    {
        Game.NextPlayer();
        await DrawNext();
        _answerGiven = false;
        StateHasChanged();
    }

}
